# üöÄ Docker Build Optimizations Guide

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è Docker —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞.

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

| –°—Ü–µ–Ω–∞—Ä–∏–π | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|----------------|-------------------|-----------|
| **–ü–µ—Ä–≤–∞—è —Å–±–æ—Ä–∫–∞ (—Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç)** | ~15-18 –º–∏–Ω | ~10-13 –º–∏–Ω | **30-40%** |
| **–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π** | ~15-18 –º–∏–Ω | ~2-3 –º–∏–Ω | **85-90%** ‚ö° |
| **–ò–∑–º–µ–Ω–µ–Ω —Ç–æ–ª—å–∫–æ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥** | ~15-18 –º–∏–Ω | ~5-8 –º–∏–Ω | **60-70%** |
| **–ò–∑–º–µ–Ω–µ–Ω package.json** | ~15-18 –º–∏–Ω | ~10-11 –º–∏–Ω | **30-40%** |

---

## üîß –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. **BuildKit Cache Mounts** ‚≠ê‚≠ê‚≠ê

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ö—ç—à–∏—Ä—É–µ—Ç npm cache –º–µ–∂–¥—É —Å–±–æ—Ä–∫–∞–º–∏ Docker

```dockerfile
RUN --mount=type=cache,target=/root/.npm \
    npm ci --prefer-offline --no-audit
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ npm –º–æ–¥—É–ª–∏ –Ω–µ —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–±–æ—Ä–∫–µ
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è: 4-5 –º–∏–Ω—É—Ç ‚Üí 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

---

### 2. **Vite Build Cache** ‚≠ê‚≠ê‚≠ê

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ö—ç—à–∏—Ä—É–µ—Ç Vite build cache –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–±–æ—Ä–∫–∏

```dockerfile
RUN --mount=type=cache,target=/app/node_modules/.vite \
    npm run build
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ Vite –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–±–æ—Ä–∫–∏ –Ω–∞ 30-40%

---

### 3. **Multi-Stage Build** ‚≠ê‚≠ê

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –†–∞–∑–¥–µ–ª—è–µ—Ç —Å–±–æ—Ä–∫—É –Ω–∞ –¥–≤–∞ —ç—Ç–∞–ø–∞ (builder + nginx)

```dockerfile
FROM node:20-alpine AS builder
# ... —Å–±–æ—Ä–∫–∞ ...

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
- ‚úÖ –†–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞: ~50MB –≤–º–µ—Å—Ç–æ ~500MB

---

### 4. **Docker Layer Caching** ‚≠ê‚≠ê‚≠ê

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–æ–º–∞–Ω–¥ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

```dockerfile
# Layer 1: package.json (–º–µ–Ω—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ)
COPY package*.json ./

# Layer 2: npm install (–∫—ç—à–∏—Ä—É–µ—Ç—Å—è –µ—Å–ª–∏ package.json –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è)
RUN npm ci ...

# Layer 3: –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (–º–µ–Ω—è–µ—Ç—Å—è —á–∞—Å—Ç–æ)
COPY . .

# Layer 4: —Å–±–æ—Ä–∫–∞ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞)
RUN npm run build
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ Docker –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –Ω–µ–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–ª–æ–∏
- ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è CI/CD

---

### 5. **Vite Config Optimizations** ‚≠ê‚≠ê

**vite.config.js:**

```javascript
build: {
  minify: 'terser',
  sourcemap: false,              // –û—Ç–∫–ª—é—á–∞–µ–º sourcemaps
  reportCompressedSize: false,   // –£—Å–∫–æ—Ä—è–µ—Ç —Å–±–æ—Ä–∫—É
  rollupOptions: {
    output: {
      manualChunks: {
        'react-vendor': ['react', 'react-dom'],
        'ui-vendor': ['@radix-ui/...'],
        'table-vendor': ['@tanstack/react-table'],
      },
    },
  },
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ Chunk splitting ‚Üí –º–µ–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥
- ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ sourcemaps ‚Üí –±—ã—Å—Ç—Ä–µ–µ —Å–±–æ—Ä–∫–∞
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è 1-2 –º–∏–Ω—É—Ç—ã

---

### 6. **.dockerignore Optimization** ‚≠ê

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ò—Å–∫–ª—é—á–∞–µ—Ç –Ω–µ–Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–±–æ—Ä–∫–∏

```
node_modules
.git
.github
dist
*.md
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ –ú–µ–Ω—å—à–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí –±—ã—Å—Ç—Ä–µ–µ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Docker daemon
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è 10-30 —Å–µ–∫—É–Ω–¥

---

### 7. **–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ Timeouts** ‚≠ê

**GitHub Actions:**
```yaml
jobs:
  deploy:
    timeout-minutes: 30
    steps:
      - uses: appleboy/ssh-action@v1.0.3
        with:
          command_timeout: 30m
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç timeout –ø—Ä–∏ –ø–µ—Ä–≤–æ–π —Å–±–æ—Ä–∫–µ
- ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –¥–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

---

## üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤–∞—è —Å–±–æ—Ä–∫–∞**
```
1. COPY package.json          ‚Üí –Ω–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ
2. npm ci                      ‚Üí —Å–∫–∞—á–∏–≤–∞–µ—Ç –≤—Å—ë (4-5 –º–∏–Ω)
3. COPY –∏—Å—Ç–æ—á–Ω–∏–∫–∏              ‚Üí –Ω–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ
4. npm run build               ‚Üí –ø–æ–ª–Ω–∞—è —Å–±–æ—Ä–∫–∞ (5-8 –º–∏–Ω)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û: ~10-13 –º–∏–Ω—É—Ç
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò–∑–º–µ–Ω–µ–Ω —Ç–æ–ª—å–∫–æ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥**
```
1. COPY package.json          ‚Üí ‚úÖ CACHED (–ø—Ä–æ–ø—É—â–µ–Ω–æ)
2. npm ci                      ‚Üí ‚úÖ CACHED (–ø—Ä–æ–ø—É—â–µ–Ω–æ)
3. COPY –∏—Å—Ç–æ—á–Ω–∏–∫–∏              ‚Üí –∏–∑–º–µ–Ω–µ–Ω–æ
4. npm run build               ‚Üí –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ (5-8 –º–∏–Ω)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û: ~5-8 –º–∏–Ω—É—Ç (—ç–∫–æ–Ω–æ–º–∏—è 60%)
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π**
```
1. COPY package.json          ‚Üí ‚úÖ CACHED
2. npm ci                      ‚Üí ‚úÖ CACHED
3. COPY –∏—Å—Ç–æ—á–Ω–∏–∫–∏              ‚Üí ‚úÖ CACHED
4. npm run build               ‚Üí ‚úÖ CACHED
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û: ~2-3 –º–∏–Ω—É—Ç—ã (—ç–∫–æ–Ω–æ–º–∏—è 85%)
```

---

## üö´ –ß—Ç–æ –ù–ï –∫—ç—à–∏—Ä—É–µ—Ç—Å—è (–∏ –ø–æ—á–µ–º—É)

### 1. **–§–∏–Ω–∞–ª—å–Ω—ã–π `npm run build`**
- ‚ùå –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
- üí° –≠—Ç–æ –Ω–µ–∏–∑–±–µ–∂–Ω–æ - –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 2. **COPY –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞**
- ‚ùå –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ .jsx/.js —Ñ–∞–π–ª–∞
- üí° Docker —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç checksums –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pnpm –≤–º–µ—Å—Ç–æ npm** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```dockerfile
RUN --mount=type=cache,target=/root/.pnpm-store \
    pnpm install --frozen-lockfile
```
**–≠—Ñ—Ñ–µ–∫—Ç:** pnpm –±—ã—Å—Ç—Ä–µ–µ npm –Ω–∞ 2-3x –∑–∞ —Å—á–µ—Ç hard links

### 2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Docker Registry Cache** (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
```bash
docker buildx build --push \
  --cache-from type=registry,ref=myregistry/myapp:cache \
  --cache-to type=registry,ref=myregistry/myapp:cache
```
**–≠—Ñ—Ñ–µ–∫—Ç:** –ö—ç—à –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –≤—Å–µ—Ö –º–∞—à–∏–Ω–∞—Ö

### 3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å separate volume –¥–ª—è node_modules** (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ)
```dockerfile
RUN --mount=type=cache,target=/app/node_modules,id=node_modules \
    npm ci
```
**–≠—Ñ—Ñ–µ–∫—Ç:** node_modules –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ Docker volume

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ —Å–ª–æ–µ–≤:
```bash
docker history academic-support-frontend
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫—ç—à–∞:
```bash
DOCKER_BUILDKIT=1 docker build --progress=plain .
```

–ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ `CACHED` –≤ –≤—ã–≤–æ–¥–µ.

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

- [x] BuildKit –≤–∫–ª—é—á–µ–Ω (`DOCKER_BUILDKIT=1`)
- [x] BuildKit cache mounts –¥–ª—è npm
- [x] BuildKit cache mounts –¥–ª—è Vite
- [x] Multi-stage build
- [x] –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ COPY –∫–æ–º–∞–Ω–¥
- [x] Vite config –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω
- [x] .dockerignore –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] Timeouts —É–≤–µ–ª–∏—á–µ–Ω—ã
- [x] Node.js 20 –¥–ª—è Vite 7

---

## üéä –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú—ã –¥–æ—Å—Ç–∏–≥–ª–∏ **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –º–∞–∫—Å–∏–º—É–º–∞** –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã!

–î–∞–ª—å–Ω–µ–π—à–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ:
1. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ pnpm (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ 20-30%)
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Docker Registry cache (—Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
3. –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ –ø—Ä–æ–µ–∫—Ç–µ

**–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤! üöÄ**
