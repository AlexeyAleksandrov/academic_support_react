# Система Авторизации и Регистрации

## Обзор
В проект добавлена полная система авторизации на основе JWT токенов с поддержкой регистрации, входа и выхода из аккаунта.

## Реализованные компоненты

### 1. **AuthContext** (`src/context/AuthContext.jsx`)
- Управляет состоянием авторизации в приложении
- Хранит JWT токен в localStorage
- **Автоматически отслеживает изменения токена** через storage events и периодическую проверку
- Предоставляет методы:
  - `login(email, password)` - вход в систему
  - `register(firstName, lastName, middleName, email, password)` - регистрация
  - `logout()` - выход из системы
  - `isAuthenticated()` - проверка авторизации

### 2. **API Service** (`src/services/api.js`)
- Добавлен interceptor для автоматического добавления JWT токена в заголовки всех запросов
- **Добавлен interceptor для обработки ошибок 401 и 403** (автоматический выход при истекшем токене)
- Добавлен `authService` с методами login и register

### 3. **Компоненты форм**
- **LoginForm** (`src/components/LoginForm.jsx`) - форма входа
- **RegisterForm** (`src/components/RegisterForm.jsx`) - форма регистрации
- Включают валидацию полей и обработку ошибок
- Стилизованы с использованием CSS (`LoginForm.css`, `RegisterForm.css`)

### 4. **Страницы**
- **LoginPage** (`src/pages/LoginPage.jsx`) - страница входа
- **RegisterPage** (`src/pages/RegisterPage.jsx`) - страница регистрации

### 5. **Защищенные маршруты**
- **ProtectedRoute** (`src/components/ProtectedRoute.jsx`) - компонент для защиты маршрутов
- Автоматически перенаправляет неавторизованных пользователей на /login

### 6. **Обновленный Header**
- Показывает кнопки "Вход" и "Регистрация" для неавторизованных пользователей
- Показывает email пользователя и кнопку "Выйти" для авторизованных пользователей

## Структура маршрутов

### Публичные маршруты
- `/` - главная страница (доступна всем)
- `/login` - страница входа
- `/register` - страница регистрации

### Защищенные маршруты (требуют авторизации)
- `/rpd`
- `/rpd/:rpdId/skills`
- `/competencies`
- `/indicators`
- `/technologies`
- `/tech-groups`
- `/keywords`
- `/vacancies`
- `/experts`
- `/expert-opinions`
- `/saved-searches`
- `/foresights`

## API Endpoints

### Регистрация
```
POST /api/auth/register
Content-Type: application/json

{
  "firstName": "Иван",
  "lastName": "Иванов",
  "middleName": "Иванович",
  "email": "ivan@example.com",
  "password": "password123"
}
```

### Вход
```
POST /api/auth/login
Content-Type: application/json

{
  "email": "ivan@example.com",
  "password": "password123"
}
```

### Ответ
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

## Использование токена

Токен автоматически добавляется ко всем запросам через interceptor в `api.js`:
```
Authorization: Bearer <token>
```

## Хранение токена

JWT токен хранится в `localStorage` с ключом `authToken`. Срок действия токена - 1 час.

## Поведение при истечении токена

**При получении ошибки 401 (Unauthorized) или 403 (Forbidden):**
1. Токен автоматически удаляется из localStorage
2. AuthContext обнаруживает удаление токена (через периодическую проверку каждую секунду)
3. Состояние пользователя сбрасывается
4. Пользователь автоматически перенаправляется на страницу /login (если находится на защищенной странице)

**Это решает проблему, когда:**
- Компьютер был в спящем режиме и токен истек
- Прошло более 1 часа с момента последней авторизации
- Токен стал невалидным по любой другой причине

## Редирект после авторизации

**Система запоминает страницу, с которой пользователь попал на страницу входа:**
- Если пользователь попытался открыть `/competencies` без авторизации
- Он будет перенаправлен на `/login` с сохранением исходного URL
- После успешного входа/регистрации пользователь вернется на `/competencies`
- Если пользователь зашел на `/login` напрямую, после авторизации он попадет на главную страницу `/`

## Валидация форм

### Регистрация
- Все поля, кроме отчества, обязательны
- Пароль должен содержать минимум 6 символов
- Проверка совпадения пароля и подтверждения пароля

### Вход
- Email и пароль обязательны
- Проверка формата email

## Технические детали

### Обработка истекших токенов
Система использует многоуровневый подход:
1. **Response Interceptor** (api.js) - перехватывает 401/403 ошибки и удаляет токен
2. **Storage Event Listener** (AuthContext) - отслеживает изменения между вкладками
3. **Periodic Token Check** (AuthContext) - проверяет токен каждую секунду в текущей вкладке

### Почему обрабатываются и 401, и 403?
- **401 (Unauthorized)** - стандартная ошибка для невалидного токена
- **403 (Forbidden)** - некоторые бэкенды возвращают эту ошибку для истекших токенов
- Обработка обеих ошибок обеспечивает совместимость с разными API

## Рекомендации для разработки

1. **Refresh Token**: В будущем можно добавить механизм обновления токена
2. **Профиль пользователя**: Можно добавить endpoint для получения информации о текущем пользователе
3. **Восстановление пароля**: Добавить функционал восстановления забытого пароля
4. **Remember Me**: Опция запоминания пользователя на устройстве

## Тестирование

Для тестирования системы:
1. Запустите бэкенд с поддержкой JWT
2. Запустите React приложение: `npm run dev`
3. Перейдите на страницу регистрации и создайте аккаунт
4. Войдите в систему с созданными учетными данными
5. Попробуйте перейти на защищенные страницы
6. Проверьте функционал выхода из системы
